# Render Blueprint for SpeedTestPro
# Deploy the world's most advanced speed test platform

services:
  # Backend Service (Rust + Actix-web)
  - type: web
    name: speedtestpro-backend
    runtime: rust
    plan: starter
    buildCommand: cargo build --release
    startCommand: ./target/release/speedtest-pro-backend
    envVars:
      - key: SERVER_ID
        value: render-01
      - key: SERVER_NAME
        value: "Render Cloud"
      - key: SERVER_IP
        sync: false
      - key: BIND_HOST
        value: 0.0.0.0
      - key: BIND_PORT
        value: 8080
      - key: RUST_LOG
        value: info
      - key: DATABASE_PATH
        value: /opt/render/project/data/speedtest.db
      - key: OPENAI_API_KEY
        sync: false
      - key: OPENAI_MODEL
        value: gpt-4o-mini
      - key: OPENAI_MAX_TOKENS
        value: 500
      - key: DEFAULT_TEST_DURATION_MS
        value: 10000
      - key: MIN_TEST_DURATION_MS
        value: 5000
      - key: MAX_TEST_DURATION_MS
        value: 30000
      - key: DEFAULT_CHUNK_SIZE_BYTES
        value: 65536
      - key: LATENCY_TARGET_MS
        value: 20
      - key: JITTER_TARGET_MS
        value: 5
    healthCheckPath: /api/health
    disk:
      name: speedtest-data
      mountPath: /opt/render/project/data
      sizeGB: 1
    autoDeploy: true
    
  # Frontend Service (React + Vite)
  - type: web
    name: speedtestpro-frontend
    runtime: node
    plan: starter
    buildCommand: cd frontend && npm install && npm run build
    staticPublishPath: ./frontend/dist
    envVars:
      - key: VITE_API_BASE_URL
        value: https://speedtestpro-backend.onrender.com
      - key: VITE_WS_BASE_URL
        value: wss://speedtestpro-backend.onrender.com
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=31536000, immutable
      - path: /index.html
        name: Cache-Control
        value: no-cache
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    autoDeploy: true

# Database (PostgreSQL - Optional upgrade from SQLite)
databases:
  - name: speedtestpro-db
    databaseName: speedtest
    user: speedtest_user
    plan: starter
    ipAllowList: []
